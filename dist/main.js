!function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);var i=function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var i=Array(e),r=0;for(t=0;t<n;t++)for(var s=arguments[t],o=0,a=s.length;o<a;o++,r++)i[r]=s[o];return i};function r(e,t){for(var n=0,i=0;i<t.length;i++){var r=t[i];switch(r.t){case"retain":n+=r.v;break;case"insert":e=e.substring(0,n)+r.v+e.substring(n),n+=r.v.length;break;case"delete":e=e.substring(0,n)+e.substring(n+r.v)}}return e}function s(e,t){for(var n,i,r=[],s=0,l=0;s<e.length||l<t.length||n||i;){if(s===e.length&&void 0===n){o(r,i),a(r,t.slice(l));break}if(l===t.length&&void 0===i){o(r,n),a(r,e.slice(s));break}n=n||e[s++],i=i||t[l++];var f=(0,p[n.t][i.t])(n,i),c=f[0],h=f[1],u=f[2];n=c[0],i=h[0],a(r,u)}return r}function o(e,t){return t&&(e.length>0&&e[e.length-1].t===t.t?e[e.length-1].v+=t.v:e.push(t)),t}function a(e,t){if(t.length>0){o(e,t[0]);var n=t.slice(1);e.splice.apply(e,i([e.length,0],n))}}var l,f,c={insert:{insert:function(e,t){return[[],[t],[{t:"retain",v:e.v.length}],[e]]},retain:function(e,t){return[[],[t],[{t:"retain",v:e.v.length}],[e]]},delete:function(e,t){return[[],[],[{t:"retain",v:e.v.length},t],[e]]}},delete:{insert:function(e,t){return[[],[],[t],[{t:"retain",v:t.v.length},e]]},retain:function(e,t){var n=e.v-t.v;return[n>0?[{t:"delete",v:n}]:[],n<0?[{t:"retain",v:-n}]:[],[],n>0?[{t:"delete",v:t.v}]:[e]]},delete:function(e,t){var n=e.v-t.v;Math.min(e.v,t.v);return[n>0?[{t:"delete",v:n}]:[],n<0?[{t:"delete",v:-n}]:[],[],[]]}},retain:{insert:function(e,t){return[[e],[],[t],[{t:"retain",v:t.v.length}]]},retain:function(e,t){var n=e.v-t.v,i=Math.min(e.v,t.v);return[n>0?[{t:"retain",v:n}]:[],n<0?[{t:"retain",v:-n}]:[],[{t:"retain",v:i}],[{t:"retain",v:i}]]},delete:function(e,t){var n=e.v-t.v;return[n>0?[{t:"retain",v:n}]:[],n<0?[{t:"delete",v:-n}]:[],n<0?[{t:"delete",v:e.v}]:[t],[]]}}},p={insert:{insert:function(e,t){return[[],[],[{t:"insert",v:t.v+e.v}]]},retain:function(e,t){var n=e.v.length-t.v;return[n>0?[{t:"insert",v:e.v.slice(t.v)}]:[],n<0?[{t:"retain",v:-n}]:[],[{t:"insert",v:n>0?e.v.slice(0,t.v):e.v}]]},delete:function(e,t){var n=e.v.length-t.v;return[n>0?[{t:"insert",v:e.v.slice(t.v)}]:[],n<0?[{t:"delete",v:-n}]:[],[]]}},retain:{insert:function(e,t){return[[e],[],[t]]},retain:function(e,t){var n=e.v-t.v;return[n>0?[{t:"retain",v:n}]:[],n<0?[{t:"retain",v:-n}]:[],[{t:"retain",v:Math.min(e.v,t.v)}]]},delete:function(e,t){var n=e.v-t.v;return[n>0?[{t:"retain",v:n}]:[],n<0?[{t:"delete",v:-n}]:[],[{t:"delete",v:Math.min(e.v,t.v)}]]}},delete:{insert:function(e,t){return[[],[],[e,t]]},retain:function(e,t){return[[],[t],[e]]},delete:function(e,t){return[[],[],[{t:"delete",v:e.v+t.v}]]}}},h=(l=function(e,t){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}l(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),u=function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var i=Array(e),r=0;for(t=0;t<n;t++)for(var s=arguments[t],o=0,a=s.length;o<a;o++,r++)i[r]=s[o];return i};!function(e){e[e.Synchronized=0]="Synchronized",e[e.Awaiting=1]="Awaiting",e[e.AwaitingWithBuffer=2]="AwaitingWithBuffer"}(f||(f={}));var v=function(){function e(e,t){this.clientReceiveDisabled=!1,this.client=e,this.server=t,this.client.attachChanel(this),this.server.attachChanel(this),this.clientMessageList=[],this.serverMessageList=[]}return e.prototype.clientSendMessage=function(e){this.clientMessageList.push(e)},e.prototype.acceptClientMessage=function(){var e=this.clientMessageList.shift();e&&this.server.onReceiveMessage(e)},e.prototype.serverSendMessage=function(e){this.serverMessageList.push(e)},e.prototype.acceptServerMessage=function(){if(!this.clientReceiveDisabled){var e=this.serverMessageList.shift();e&&this.client.onReceiveMessage(e)}},e.prototype.disableClientReceive=function(){this.clientReceiveDisabled=!0},e.prototype.enableClientReceive=function(){this.clientReceiveDisabled=!1},e}(),d=function(){},g=function(e){function t(t,n){var i=e.call(this)||this;return i.version=0,i.sentOutOperations=[],i.operationBuffer=[],i.name=t,i.text=n,i}return h(t,e),t.prototype.attachChanel=function(e){this.channel=e},t.prototype.onClientChange=function(e){var t;if(0!==e.length)if(0===this.sentOutOperations.length){var n={version:this.version,clientName:this.name,operations:u(e)};null===(t=this.channel)||void 0===t||t.clientSendMessage(n),this.sentOutOperations=e}else this.operationBuffer=s(this.operationBuffer,e)},t.prototype.onReceiveMessage=function(e){var t;if(e.clientName===this.name&&(this.sentOutOperations=[],this.version=e.version,this.sentOutOperations.length&&(this.sentOutOperations=[]),this.operationBuffer.length)){var n={version:this.version,clientName:this.name,operations:this.operationBuffer};null===(t=this.channel)||void 0===t||t.clientSendMessage(n),this.sentOutOperations=this.operationBuffer,this.operationBuffer=[]}},t.prototype.getClientState=function(){return 0===this.sentOutOperations.length?f.Synchronized:0===this.operationBuffer.length?f.Awaiting:f.AwaitingWithBuffer},t}(d),m=function(e){function t(t){var n=e.call(this)||this;return n.channels=[],n.operationsList=[],n.version=0,n.text=t,n}return h(t,e),t.prototype.attachChanel=function(e){this.channels.push(e)},t}(d);function b(e){return $('<table class="table table-condensed table-noheader">\n        '+(void 0!==e.clientName?"<tr><td><strong>Author</strong></td><td>"+e.clientName+"</td></tr>":"")+"\n        "+(void 0!==e.version?"<tr><td><strong>Revision</strong></td><td>"+e.version+"</td></tr>":"")+"\n        <tr><td><strong>Changeset</strong></td><td>"+(t=e.operations,t.map((function(e){var t="insert"===e.t?e.v.replace(/\n/g,"\\n"):e.v;return'<span title="'+t+'" class="'+e.t+' op-text">'+e.t+'("'+t+'")</span>'})).join(""))+"</td></tr>\n        </table>")[0];var t}var y=function(e){function t(t,n,i){var r=e.call(this,n,i)||this;return r.clientMessageElements=[],r.serverMessageElements=[],r.node=t,$(t).css("height","150px"),r}return h(t,e),t.prototype.clientSendMessage=function(t){e.prototype.clientSendMessage.call(this,t);var n=$('<div class="message '+t.clientName+'" style="top:200px;"></div>');$(this.node).find(".up .connection").append(n),n.popover({title:"Operation",trigger:"hover",html:!0,content:b(t)}),setTimeout((function(){n.css("top","75px")}),10),this.clientMessageElements.push(n),this.enableClientSend()},t.prototype.enableClientSend=function(){var e=this;$(e.node).find(".up a").removeClass("disabled").click((function(){var t=e.clientMessageElements.shift();t.css("top","-50px"),setTimeout((function(){e.acceptClientMessage(),t.popover("destroy"),t.remove()}),500)}))},t.prototype.acceptClientMessage=function(){e.prototype.acceptClientMessage.call(this),$(this.node).find(".up a").addClass("disabled").off("click")},t.prototype.serverSendMessage=function(t){var n=this;e.prototype.serverSendMessage.call(this,t);var i=$('<div class="message '+t.clientName+t.version+'" style="top:'+-50+'px;"></div>');i.popover({title:"Operation",trigger:"hover",html:!0,content:b(t)}),$(this.node).find(".down .connection").append(i),this.serverMessageElements.push(i),setTimeout((function(){n.adjustServerMessagePosition()}),10),this.enableClientReceive()},t.prototype.adjustServerMessagePosition=function(){var e=this,t=90/(this.serverMessageElements.length+1);this.serverMessageElements.forEach((function(n,i){n.css("top",30+(e.serverMessageElements.length-i)*t+"px")}))},t.prototype.acceptServerMessage=function(){e.prototype.acceptServerMessage.call(this),0===this.serverMessageElements.length&&this.disableClientReceive()},t.prototype.disableClientReceive=function(){e.prototype.disableClientReceive.call(this),$(this.node).find(".down a").addClass("disabled").off("click")},t.prototype.enableClientReceive=function(){var t=this,n=$(t.node).find(".down a");e.prototype.enableClientReceive.call(this),n.hasClass("disabled")&&n.removeClass("disabled").click((function(){var e=t.serverMessageElements.shift();e.css("top","200px"),t.adjustServerMessagePosition(),setTimeout((function(){t.acceptServerMessage(),e.popover("destroy"),e.remove()}),500)}))},t}(v);function O(e){e.operations=u(e.operations)}var x=function(e,t){var n=this;this.transformedBeforeOps=[],this.transformedAfterOps=[],this.beforeOperations=e,this.afterOperations=t,this.beforeOperations.forEach(O),this.afterOperations.forEach(O);var i=$("#transformModal");if("none"!==i.css("display"))throw"Transform Modal is already opened";if(0===e.length||0===t.length)throw"Transform operations must not be empty";setTimeout((function(){i.modal("show"),i.find(".finish-btn").attr("disabled",!0),i.find(".transform-area .processing .operations-area>div>div").css("height","120px");var e=n.beforeOperations.shift(),t=n.afterOperations.shift();function r(e,t){return e.unshift=function(e){var n=$('<div class="ops-block" style="left:0px">'+e.label+"</div>");return n.css("left","-350px"),i.find(".transform-area.before .waiting ."+t).append(n),setTimeout((function(){n.css("left","0px")}),10),Array.prototype.unshift.call(this,e)},e.shift=function(){var e=Array.prototype.shift.call(this);return e&&i.find(".transform-area.before .waiting ."+t+" div").last().remove(),e},e.map((function(e){return i.find(".transform-area.before .waiting ."+t).prepend('<div class="ops-block" style="left:0px">'+e.label+"</div>")}))}function s(e){return""+("insert"===e.t?'"'+e.v+'"':e.v)}function a(e){return $('<div class="op-block '+e.t+'" title="'+e.v+'">'+s(e)+"</div>")}function l(e,t){i.find(".transform-area.before .processing .title ."+t).text(e.label);for(var n=e.operations,r=null,s=[],o=0;o<n.length;o++){var l=a(n[o]);i.find(".transform-area.before .processing .operations-area ."+t).prepend(l),s.push(l)}n.length>4&&((r=$('<div class="op-block collapse">...</div>')).css("top","-30px"),i.find(".transform-area.before .processing .operations-area ."+t).prepend(r),setTimeout((function(){r&&r.css("top","0px")}),10)),n.shift=function(){if(this.length>0){var e=s.shift();e.css("bottom","0px"),setTimeout((function(){e.css("bottom","-30px"),setTimeout((function(){e.remove()}),200)}),10)}var t=Array.prototype.shift.apply(this);if(4==this.length){var n=r;n.css("top","0px"),setTimeout((function(){n.remove()}),200),r=null}return t},n.unshift=function(e){var n=a(e);return n.css("left","-350px"),n.css("position","absolute"),i.find(".transform-area.before .processing .operations-area ."+t).append(n),s.unshift(n),setTimeout((function(){n.css("left","0px"),setTimeout((function(){n.css("position","")}),200)}),10),s.length>4&&null===r&&((r=$('<div class="op-block collapse">...</div>')).css("top","-30px"),i.find(".transform-area.before .processing .operations-area ."+t).prepend(r),setTimeout((function(){r&&r.css("top","0px")}),10)),Array.prototype.unshift.call(this,e),1}}r(n.beforeOperations,"left"),r(n.afterOperations,"right"),l(e,"left"),l(t,"right");var f=[],p=[],h=[],u=[];function v(e,t){e.push=function(e){return i.find(".transform-area.after .waiting ."+t).prepend('<div class="ops-block" style="left:0px">'+e.label+"</div>"),Array.prototype.push.call(this,e)},e.shift=function(){var e=i.find(".transform-area.after .waiting ."+t+" > *").last();return setTimeout((function(){e.css("left","-350px"),setTimeout((function(){e.remove()}),400)}),10),Array.prototype.shift.apply(this)}}function d(e,t,n){var r=a(e);i.find(".transform-btn").attr("disabled",!0),i.find(".transform-area.after .pipe-area ."+t).prepend(r),r.css("top","0px"),setTimeout((function(){r.css("top","150px"),setTimeout((function(){r.remove(),i.find(".transform-btn").attr("disabled",!1),n&&n()}),600)}),10)}function g(e,t){var n=null;e.push=function(e){var r=this.length;return d(e,t,(function(){var n=a(e);n.addClass("op"+r),n.css("top","-30px"),i.find(".transform-area.after .operations-area ."+t).prepend(n),setTimeout((function(){n.css("top","0px")}),10)})),4===r&&null===n&&((n=$('<div class="op-block collapse">...</div>')).css("bottom","-30px"),i.find(".transform-area.after .processing .operations-area ."+t).prepend(n),setTimeout((function(){n.css("bottom","0px")}),10)),Array.prototype.push.call(this,e)}}function m(e,t,n){var r=e.length;if(t.forEach((function(t){var i=e.length;o(e,t),i===e.length&&d(t,n)})),r>0){var a=e[r-1];setTimeout((function(){i.find(".transform-area.after .operations-area ."+n+" .op"+(r-1)).text(s(a))}),600)}}v(h,"left"),v(u,"right"),g(f,"left"),g(p,"right"),i.find(".transform-btn").click((function(){var r,s;if(0===e.operations.length&&0===t.operations.length){var o={label:e.label+"'",operations:f},a={label:t.label+"'",operations:p};if(i.find(".transform-area.after .operations-area .left").empty(),i.find(".transform-area.after .operations-area .right").empty(),p=[],g(f=[],"left"),g(p,"right"),h.push(o),u.push(a),n.afterOperations.length>0)h.shift(),n.beforeOperations.unshift(o);else if(n.beforeOperations.length>0)for(;u.length>0;){var v=u.shift();n.afterOperations.push(v)}0!==n.beforeOperations.length?(e=n.beforeOperations.shift(),t=n.afterOperations.shift(),l(e,"left"),l(t,"right")):(i.find(".finish-btn").attr("disabled",!1),i.find(".transform-btn").attr("disabled",!0),i.find(".finish-btn").click((function(){n.onFinish&&n.onFinish(u,h),i.find(".finish-btn").off(),i.find(".transform-btn").off(),i.find(".transform-btn").attr("disabled",!1),i.find(".transform-area.after .waiting>div").empty(),i.modal("hide")})))}else{var d=function(e,t){if(0===e.length&&0!==t.length)return[[t.shift()],[]];if(0===t.length&&0!==e.length)return[[],[e.shift()]];var n=e.shift(),i=t.shift(),r=(0,c[n.t][i.t])(n,i),s=r[0],o=r[1],a=r[2],l=r[3];return s.forEach((function(t){return e.unshift(t)})),o.forEach((function(e){return t.unshift(e)})),[a,l]}(null===(r=e)||void 0===r?void 0:r.operations,null===(s=t)||void 0===s?void 0:s.operations),b=d[0],y=d[1];m(f,y,"left"),m(p,b,"right")}}))}),1)};var M=function(e){function t(t,n,i){var r=e.call(this,n,i)||this;return r.changeTriggerByCode=!1,r.node=t,$(t).find(".name").text(n),r.syncStatusUI(),r.codeMirror=CodeMirror($(t).find(".text-input")[0],{lineNumbers:!0,lineWrapping:!0,value:i}),r.codeMirror.on("change",(function(e,t){if(r.changeTriggerByCode)r.changeTriggerByCode=!1;else{var n=e.getValue(),i=function(e,t){for(var n=0,i=0,r=0;i<e.length&&r<t.length&&e[i]===t[r];)n++,i++,r++;var s=0!==n?[{t:"retain",v:n}]:[];if(e.length>=t.length){var o=e.length-t.length;i+=o;for(var a=r,l=0;i<e.length&&r<t.length&&e[i]!==t[r];)i++,r++,o++,l++;var f=0!==l?[{t:"insert",v:t.substr(a,l)}]:[];return u(s,[{t:"delete",v:o}],f)}return u(s,[{t:"insert",v:t.substr(n,t.length-e.length)}])}(r.text,n);r.text=n,r.onClientChange(i)}})),r}return h(t,e),t.prototype.setValue=function(e){this.changeTriggerByCode=!0,this.codeMirror.setValue(e)},t.prototype.onClientChange=function(t){e.prototype.onClientChange.call(this,t),this.syncStatusUI()},t.prototype.syncStatusUI=function(){var t=$(this.node).find(".state-area");if($(this.node).find(".state-area .message").popover("destroy"),$(this.node).find(".revision-area").text(this.version.toString()),t.empty(),this.sentOutOperations.length){var n=$('<div class="message '+this.name+'"></div>').popover({title:"Operation",trigger:"hover",html:!0,content:b({operations:this.sentOutOperations})});t.append(n)}var i="";switch(e.prototype.getClientState.call(this)){case f.Awaiting:i="Awaiting";break;case f.AwaitingWithBuffer:i="Awaiting With Buffer";break;case f.Synchronized:i="Synchronized"}if(t.append("<span>"+i+"</span>"),this.operationBuffer.length){var r=$('<div class="message '+this.name+'"></div>').popover({title:"Operation",trigger:"hover",html:!0,content:b({operations:this.operationBuffer})});t.append(r)}},t.prototype.onReceiveMessage=function(t){var n,i=this;if(e.prototype.onReceiveMessage.call(this,t),t.clientName===this.name)this.syncStatusUI();else if(this.getClientState()===f.Synchronized)this.text=r(this.text,t.operations),this.setValue(this.text),this.version=t.version||0,this.syncStatusUI();else{null===(n=this.channel)||void 0===n||n.disableClientReceive();var s=[];this.sentOutOperations.length&&s.push({label:"Sent Out Operations",operations:this.sentOutOperations}),this.operationBuffer.length&&s.push({label:"Pending Operations",operations:this.operationBuffer}),new x([{label:t.clientName,operations:t.operations}],s).onFinish=function(e,t){var n;t.forEach((function(e){i.text=r(i.text,e.operations)})),i.setValue(i.text),e.forEach((function(e,t){0===t&&(i.sentOutOperations=e.operations),1===t&&(i.operationBuffer=e.operations)})),i.syncStatusUI(),null===(n=i.channel)||void 0===n||n.enableClientReceive()}}},t}(g),C=function(e){function t(t,n){var i=e.call(this,n)||this;return i.messageElements=[],i.node=t,$(i.node).find(".content-area").text(i.text),$(i.node).find(".revision-area").text(i.version.toString()),i}return h(t,e),t.prototype.applyLabelOperation=function(e,t){this.text=r(this.text,e.operations),this.version++;var n={clientName:t,version:this.version,operations:e.operations},i=$('<div class="message '+t+"-"+this.version+'"></div>').popover({title:"Operation",trigger:"hover",html:!0,content:b(n)});$(this.node).find(".history-area").append(i),this.messageElements.push(i),this.operationsList.push(n),$(this.node).find(".content-area").text(this.text),$(this.node).find(".revision-area").text(this.version.toString()),this.channels.forEach((function(e){e.serverSendMessage(n)}))},t.prototype.onReceiveMessage=function(e){var t=this,n=e.version||0;if(n===this.version)this.applyLabelOperation({label:e.clientName,operations:e.operations},e.clientName);else{for(var i=[],r=n;r<this.version;r++)i=s(i,this.operationsList[r].operations);new x([{label:"Previous Operations",operations:i}],[{label:e.clientName,operations:e.operations}]).onFinish=function(n,i){n.forEach((function(n){t.applyLabelOperation(n,e.clientName)}))}}},t}(m);$("#transformModal").modal({backdrop:"static",keyboard:!1,show:!1}),$(".client-container").clone().appendTo(".clients-container");var S=new M($(".client")[0],"Alice","hello world"),w=new M($(".client")[1],"Bob","hello world"),T=new C($("#server")[0],"hello world");new y($(".chanels")[0],S,T),new y($(".chanels")[1],w,T)}]);
//# sourceMappingURL=main.js.map